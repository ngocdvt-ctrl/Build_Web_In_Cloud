<script>
  function escapeToBr(text) {
    return (text || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;")
      .replaceAll("\n", "<br>");
  }

  function ymd(dateStr) {
    if (!dateStr) return "";
    const dt = new Date(dateStr);
    if (isNaN(dt.getTime())) return "";
    return `${dt.getFullYear()}/${String(dt.getMonth()+1).padStart(2,"0")}/${String(dt.getDate()).padStart(2,"0")}`;
  }

  function humanType(ct) {
    if (!ct) return "";
    if (ct.includes("pdf")) return "PDF";
    if (ct.includes("image")) return "Image";
    if (ct.includes("zip")) return "ZIP";
    return ct;
  }

  function buildAttachmentRow(att) {
    const row = document.createElement("div");
    row.className = "attach-item";

    const left = document.createElement("div");
    left.className = "attach-left";

    const name = document.createElement("div");
    name.className = "attach-name";
    name.textContent = att.filename || "file";

    const meta = document.createElement("div");
    meta.className = "attach-meta";
    meta.textContent = humanType(att.content_type || "");

    left.appendChild(name);
    if (meta.textContent) left.appendChild(meta);

    const actions = document.createElement("div");
    actions.className = "attach-actions";

    const openBtn = document.createElement("a");
    openBtn.className = "btn-sm";
    openBtn.textContent = "開く";
    openBtn.target = "_blank";
    openBtn.rel = "noopener";
    openBtn.href = `/api/attachments/${encodeURIComponent(att.id)}/download`;

    actions.appendChild(openBtn);

    row.appendChild(left);
    row.appendChild(actions);
    return row;
  }

  async function fetchPost(postId) {
    const res = await fetch(`/api/posts/${encodeURIComponent(postId)}`, { method: "GET" });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.message || "Not Found");
    return data;
  }

  async function isLoggedIn() {
    const res = await fetch("/api/me", {
      method: "GET",
      credentials: "include",
      cache: "no-store",
    });
    return res.ok;
  }

  async function fetchAttachments(postId) {
    const res = await fetch(`/api/posts/${encodeURIComponent(postId)}/attachments`, {
      method: "GET",
      credentials: "include",
      cache: "no-store",
    });

    if (res.status === 401) return { unauthorized: true, items: [] };

    const data = await res.json().catch(() => ([]));
    if (!res.ok) throw new Error((data && data.message) || "Failed to load attachments");

    const items = Array.isArray(data) ? data : (data.items || []);
    return { unauthorized: false, items };
  }

  // ==============================
  // init page
  // ==============================
  (async function init() {
    const params = new URLSearchParams(location.search);
    const postId = (params.get("id") || "").trim();

    if (!postId) {
      document.getElementById("post-title").textContent = "Not Found";
      return;
    }

    // 1) render post (public)
    try {
      const post = await fetchPost(postId);
      document.title = post.title || "Post";
      document.getElementById("post-title").textContent = post.title || "";
      document.getElementById("post-date").textContent = ymd(post.created_at);
      document.getElementById("post-content").innerHTML = escapeToBr(post.content || "");
    } catch (e) {
      console.error(e);
      document.getElementById("post-title").textContent = "Not Found";
      return;
    }

    // 2) Attachments: "click to open"
    const card = document.getElementById("attach-card");
    const sub = document.getElementById("attach-sub");
    const list = document.getElementById("attach-list");

    let loaded = false;

    // trạng thái ban đầu: luôn hiện nhưng chưa load file
    sub.textContent = "クリックして表示（ログインが必要）";
    list.innerHTML = "";

    card.addEventListener("click", async (e) => {
      // nếu user click đúng vào link "開く" thì thôi (đừng intercept)
      if (e.target.closest("a")) return;

      // nếu đã load rồi thì toggle mở/đóng đơn giản
      if (loaded) {
        const isHidden = list.style.display === "none";
        list.style.display = isHidden ? "block" : "none";
        sub.textContent = isHidden ? "資料一覧" : "クリックして折りたたむ";
        return;
      }

      // lần click đầu: check login
      const ok = await isLoggedIn();
      if (!ok) {
        // ✅ giống production: không show tài liệu, chuyển login
        location.href = "login.html";
        return;
      }

      // logged in -> load attachments
      sub.textContent = "読み込み中...";
      try {
        const r = await fetchAttachments(postId);

        if (r.unauthorized) {
          location.href = "login.html";
          return;
        }

        if (!r.items.length) {
          sub.textContent = "添付資料はありません";
          loaded = true;
          return;
        }

        list.innerHTML = "";
        r.items.forEach(att => list.appendChild(buildAttachmentRow(att)));

        list.style.display = "block";
        sub.textContent = "資料一覧";
        loaded = true;
      } catch (err) {
        console.error(err);
        sub.textContent = "添付資料の取得に失敗しました";
      }
    });
  })();
</script>
